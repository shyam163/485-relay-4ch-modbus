# ESPHome configuration for 485 Relay 4CH v1.1
# Board: Seeed XIAO ESP32-S3
# Connection: TTL direct (D3=TX, D4=RX)

esphome:
  name: relay-4ch
  friendly_name: "Modbus Relay 4CH"

esp32:
  board: seeed_xiao_esp32s3
  framework:
    type: arduino

# Enable logging (on USB, not UART)
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_key

ota:
  platform: esphome
  password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "Relay-4CH-Fallback"
    password: "fallback123"

captive_portal:

# UART for Modbus RTU communication
# XIAO ESP32-S3: D3=GPIO4 (TX), D4=GPIO5 (RX)
uart:
  id: mod_uart
  tx_pin: GPIO4
  rx_pin: GPIO5
  baud_rate: 9600
  stop_bits: 1
  parity: NONE

# Modbus RTU configuration
modbus:
  id: modbus1
  uart_id: mod_uart

# Modbus Controller for the relay board
modbus_controller:
  - id: relay_board
    address: 0x1            # Device ID 1
    modbus_id: modbus1
    setup_priority: -10
    update_interval: 500ms  # Poll every 500ms
    command_throttle: 50ms  # Min 50ms between commands

# =============================================================================
# GLOBAL VARIABLE: Enable/Disable Input-to-Relay Automation
# =============================================================================
globals:
  - id: input_relay_enabled
    type: bool
    restore_value: yes
    initial_value: 'true'

# =============================================================================
# RELAY SWITCHES (Function 05 - Write Single Coil)
# Address 0x0000-0x0003 for Relay 1-4
# =============================================================================
switch:
  # Toggle for Input-to-Relay automation
  - platform: template
    name: "Input-to-Relay Auto"
    id: input_relay_auto
    icon: "mdi:link-variant"
    optimistic: true
    restore_mode: RESTORE_DEFAULT_ON
    lambda: |-
      return id(input_relay_enabled);
    turn_on_action:
      - globals.set:
          id: input_relay_enabled
          value: 'true'
      - logger.log: "Input-to-Relay automation ENABLED"
    turn_off_action:
      - globals.set:
          id: input_relay_enabled
          value: 'false'
      - logger.log: "Input-to-Relay automation DISABLED"
  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Relay 1"
    id: relay_1
    register_type: coil
    address: 0x0000
    icon: "mdi:electric-switch"

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Relay 2"
    id: relay_2
    register_type: coil
    address: 0x0001
    icon: "mdi:electric-switch"

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Relay 3"
    id: relay_3
    register_type: coil
    address: 0x0002
    icon: "mdi:electric-switch"

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Relay 4"
    id: relay_4
    register_type: coil
    address: 0x0003
    icon: "mdi:electric-switch"

# =============================================================================
# OPTO-ISOLATED INPUTS (Function 02 - Read Discrete Inputs)
# Address 0x0000, bits 0-3 for Input 1-4
# Inputs are ACTIVE LOW: 0 = triggered, 1 = not triggered
# Input-to-Relay automation: IN1→R1, IN2→R2, IN3→R3, IN4→R4
# =============================================================================
binary_sensor:
  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Input 1"
    id: input_1
    register_type: discrete_input
    address: 0x0000
    bitmask: 0x01
    icon: "mdi:electric-switch-closed"
    filters:
      - invert:  # Active LOW - invert so ON = triggered
    on_press:
      then:
        - if:
            condition:
              lambda: 'return id(input_relay_enabled);'
            then:
              - switch.turn_on: relay_1
              - logger.log: "Input 1 triggered → Relay 1 ON"
    on_release:
      then:
        - if:
            condition:
              lambda: 'return id(input_relay_enabled);'
            then:
              - switch.turn_off: relay_1
              - logger.log: "Input 1 released → Relay 1 OFF"

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Input 2"
    id: input_2
    register_type: discrete_input
    address: 0x0000
    bitmask: 0x02
    icon: "mdi:electric-switch-closed"
    filters:
      - invert:
    on_press:
      then:
        - if:
            condition:
              lambda: 'return id(input_relay_enabled);'
            then:
              - switch.turn_on: relay_2
              - logger.log: "Input 2 triggered → Relay 2 ON"
    on_release:
      then:
        - if:
            condition:
              lambda: 'return id(input_relay_enabled);'
            then:
              - switch.turn_off: relay_2
              - logger.log: "Input 2 released → Relay 2 OFF"

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Input 3"
    id: input_3
    register_type: discrete_input
    address: 0x0000
    bitmask: 0x04
    icon: "mdi:electric-switch-closed"
    filters:
      - invert:
    on_press:
      then:
        - if:
            condition:
              lambda: 'return id(input_relay_enabled);'
            then:
              - switch.turn_on: relay_3
              - logger.log: "Input 3 triggered → Relay 3 ON"
    on_release:
      then:
        - if:
            condition:
              lambda: 'return id(input_relay_enabled);'
            then:
              - switch.turn_off: relay_3
              - logger.log: "Input 3 released → Relay 3 OFF"

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Input 4"
    id: input_4
    register_type: discrete_input
    address: 0x0000
    bitmask: 0x08
    icon: "mdi:electric-switch-closed"
    filters:
      - invert:
    on_press:
      then:
        - if:
            condition:
              lambda: 'return id(input_relay_enabled);'
            then:
              - switch.turn_on: relay_4
              - logger.log: "Input 4 triggered → Relay 4 ON"
    on_release:
      then:
        - if:
            condition:
              lambda: 'return id(input_relay_enabled);'
            then:
              - switch.turn_off: relay_4
              - logger.log: "Input 4 released → Relay 4 OFF"
