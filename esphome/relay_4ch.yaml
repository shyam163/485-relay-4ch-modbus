# ESPHome configuration for 485 Relay 4CH v1.1
# Board: Seeed XIAO ESP32-S3
# Connection: TTL direct (D3=TX, D4=RX)

esphome:
  name: relay-4ch
  friendly_name: "Modbus Relay 4CH"

esp32:
  board: seeed_xiao_esp32s3
  framework:
    type: arduino

# Enable logging (on USB, not UART)
logger:
  level: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_key

ota:
  platform: esphome
  password: !secret ota_password

wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  ap:
    ssid: "Relay-4CH-Fallback"
    password: "fallback123"

captive_portal:

# UART for Modbus RTU communication
# XIAO ESP32-S3: D3=GPIO4 (TX), D4=GPIO5 (RX)
uart:
  id: mod_uart
  tx_pin: GPIO4
  rx_pin: GPIO5
  baud_rate: 9600
  stop_bits: 1
  parity: NONE

# Modbus RTU configuration
modbus:
  id: modbus1
  uart_id: mod_uart

# Modbus Controller for the relay board
modbus_controller:
  - id: relay_board
    address: 0x1            # Device ID 1
    modbus_id: modbus1
    setup_priority: -10
    update_interval: 500ms  # Poll every 500ms
    command_throttle: 50ms  # Min 50ms between commands

# =============================================================================
# RELAY SWITCHES (Function 05 - Write Single Coil)
# Address 0x0000-0x0003 for Relay 1-4
# =============================================================================
switch:
  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Relay 1"
    id: relay_1
    register_type: coil
    address: 0x0000
    icon: "mdi:electric-switch"

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Relay 2"
    id: relay_2
    register_type: coil
    address: 0x0001
    icon: "mdi:electric-switch"

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Relay 3"
    id: relay_3
    register_type: coil
    address: 0x0002
    icon: "mdi:electric-switch"

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Relay 4"
    id: relay_4
    register_type: coil
    address: 0x0003
    icon: "mdi:electric-switch"

# =============================================================================
# OPTO-ISOLATED INPUTS (Function 02 - Read Discrete Inputs)
# Address 0x0000, bits 0-3 for Input 1-4
# Inputs are ACTIVE LOW: 0 = triggered, 1 = not triggered
# =============================================================================
binary_sensor:
  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Input 1"
    id: input_1
    register_type: discrete_input
    address: 0x0000
    bitmask: 0x01
    icon: "mdi:electric-switch-closed"
    filters:
      - invert:  # Active LOW - invert so ON = triggered

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Input 2"
    id: input_2
    register_type: discrete_input
    address: 0x0000
    bitmask: 0x02
    icon: "mdi:electric-switch-closed"
    filters:
      - invert:

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Input 3"
    id: input_3
    register_type: discrete_input
    address: 0x0000
    bitmask: 0x04
    icon: "mdi:electric-switch-closed"
    filters:
      - invert:

  - platform: modbus_controller
    modbus_controller_id: relay_board
    name: "Input 4"
    id: input_4
    register_type: discrete_input
    address: 0x0000
    bitmask: 0x08
    icon: "mdi:electric-switch-closed"
    filters:
      - invert:

# =============================================================================
# OPTIONAL: Input-to-Relay Automation
# Uncomment to make inputs directly control relays
# =============================================================================
# automation:
#   - id: input1_to_relay1
#     trigger:
#       - platform: state
#         entity_id: binary_sensor.input_1
#     action:
#       - switch.turn_on: relay_1
#         condition:
#           - binary_sensor.is_on: input_1
#       - switch.turn_off: relay_1
#         condition:
#           - binary_sensor.is_off: input_1
